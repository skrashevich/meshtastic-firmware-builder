networks:
  proxy:
    driver: bridge

services:
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy
    environment:
      CONTAINERS: 1
      POST: 1
      DELETE: 1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - proxy
    restart: unless-stopped

  backend:
    build:
      context: ./backend
    environment:
      APP_PORT: "${APP_PORT}"
      APP_WORKDIR: "${APP_WORKDIR}"
      APP_CONCURRENT_BUILDS: "${APP_CONCURRENT_BUILDS}"
      APP_RETENTION_HOURS: "${APP_RETENTION_HOURS}"
      APP_BUILD_TIMEOUT_MINUTES: "${APP_BUILD_TIMEOUT_MINUTES}"
      APP_BUILDER_IMAGE: "${APP_BUILDER_IMAGE}"
      APP_PLATFORMIO_JOBS: "${APP_PLATFORMIO_JOBS}"
      APP_ALLOWED_ORIGINS: "${APP_ALLOWED_ORIGINS}"
      APP_MAX_LOG_LINES: "${APP_MAX_LOG_LINES}"
      APP_BUILD_RATE_LIMIT_PER_MINUTE: "${APP_BUILD_RATE_LIMIT_PER_MINUTE}"
      APP_REQUIRE_CAPTCHA: "${APP_REQUIRE_CAPTCHA:-1}"
      APP_DOCKER_HOST_WORKDIR: "${APP_DOCKER_HOST_WORKDIR:-${PWD}/build-workdir}"
      APP_DOCKER_HOST_CACHE_DIR: "${APP_DOCKER_HOST_CACHE_DIR:-${PWD}/build-workdir/platformio-cache}"
      DOCKER_HOST: "tcp://docker-socket-proxy:2375"
    volumes:
      - ${APP_DOCKER_HOST_WORKDIR:-${PWD}/build-workdir}:/app/build-workdir
    networks:
      - default
      - proxy
    depends_on:
      - docker-socket-proxy
    ports:
      - "8081:8080"

  frontend:
    build:
      context: ./frontend
      args:
        VITE_API_BASE_URL: "${VITE_API_BASE_URL}"
    depends_on:
      - backend
    ports:
      - "5174:80"
